# EzAvg
一个简单的文字冒险游戏引擎

## 目录
src/
源码

scene/
场景脚本

lua
lua脚本

lua/behaviour
精灵行为脚本，处理动画和交互相关的内容

lua/task
任务，与场景脚本相配合

## 引擎简介
这是一个超超超超超简陋的AVG文字冒险游戏引擎，EzAvg制作的游戏由场景脚本所构成，并通过Lua脚本来创建和控制精灵。

### 框架
#### 类型
- *eaApplication* 是整个程序的入口，每个 *EzAvg* 有且只有一个 *eaApplication* 。
- *eaLua* 负责管理Lua相关的内容，由 *eaApplication* 创建并管理。
- *eaLuaDomain* Lua域，其中的DoString和DoFile会在运行之前创建并绑定一个新的上值来防止污染全局环境，支持从Domain中创建Domain，此时新的域可以访问到上一个域内。在 *eaApplication* 中包含一个全局域，其他域均由其创建
- *eaLuaFunctionDefines* 定义并自动注册所有在Lua中可调用的EzAvg函数
- *eaScene* 负责管理 *eaSprite* 以及 *eaSpriteBehaviour*
- *eaScript...* 与场景脚本相关。在执行场景脚本时，*eaScriptRunner* 会为可执行脚本块创建对应的 *eaScriptTask* ，当*eaScriptTask* 不在有效时(enabled=false)，跳到下一个块
- *eaScriptRunner* 脚本运行器，开始运行脚本后会为当前运行的脚本创建对应的域
- *eaSprite...* 精灵，场景中最基础的元素，可与一个或多个 *eaSpriteBehaviour* 绑定
- *eaTime* 时间类，由 *eaApplication* 刷新，可计算到上次刷新的时间
- *eaPersistentData* 保留数据类，用来保存特殊数值
- *eaScriptTask* 与Lua任务相互绑定，构造时会自动创建对应的Lua任务，以及对应的域
- *eaSpriteBehaviour* 与Lua精灵行为绑定，构造时会自动创建对应的Lua精灵行为，以及对应的域

#### 扩展
若希望通过加入自己的Lua脚本来扩展引擎，请必须详细查看本节
游戏内支持保存与加载，但是需要遵从一定规则：
- 所有任务和行为内需要保存的数据必须设置到返回的表内，保存时会自动保存表内的数字、布尔、表和字符串
- 不要过于依赖start方法来进行初始化，要记住，如果保存时已经调用过start，加载后就不会再调用
- 任务和精灵行为脚本很相似，但是二者用处不同。如果任务脚本一直运行会造成场景的阻塞，会停在这个任务不往下执行，但是精灵行为脚本一直执行也不会造成阻塞。可以利用场景脚本的阻塞与精灵行为结合来实现按钮与分支选择的功能
- 不要使用协程，不要使用协程，不要使用协程
- 调试阶段建议在Lua中加入自己的异常处理
- 无需担心精灵和场景的属性，其所有属性均已自动保存

### 场景脚本
场景脚本是EzAvg游戏的基础，而 *块* 是场景脚本的基础，一共有五种 *块* ：
1. 注释块
以#开头，其后的一整行为注释块
1. 任务块
以:开头的一行或多行为任务块，任务块形式如下：
:[TaskName] arg1=value arg2=value ......
其中value支持四种类型：
	1. 数字
	整数和小数均可使用
	1. 字符串
	左右两端为引号的一串无换行文本，支持内嵌Lua字符串对象，例如 `"你好{return '世界'}"` 将会在运行时变成 `"你好世界"`
	1. 枚举
	与字符串类似，但是只允许由数字、字幕构成，两端不需要引号。所有枚举类型均会以字符串读入
	1. 数组
	由方括号包围，如 `[a,"b",{return "c"},4]`
	1. Lua对象
	通过在运行时调用Lua脚本动态获取结果，由花括号包围，并包含一个返回值，例如 `:Wait time={return 123}` 与 `:Wait time=123` 等价
1. Lua块
	由花括号包围的一串Lua代码
1. 文本块
	对SetText任务的简化，由任意非其他块首字符开头，并由空行结尾。程序会执行任务 `:SetText text=str` 其中str为文本块的字符串。文本块字符串也支持内嵌Lua字符串对象。
	
所有任务都会交给对应的Lua任务脚本执行
### Lua任务脚本
一个完整的Lua任务脚本如下：
```lua
local p = {}

-- 储存当前任务状态
p.enabled = true

-- 任务刷新
function p.update()
end

-- 任务启动，其中 args 的类型为 table ，对应着在场景脚本中任务块参数
function p.start(args)
end

-- 返回任务脚本对象
return p
```
当任务创建后，首先会调用其start方法，并且在下一帧开始调用其update方法。如果 `enabled=false` 或者 `enabled=nil` ，将不会调用update方法，也就是说，如果不需要刷新的任务可以简化为：
```lua
local p = {}

-- 任务启动，其中 args 的类型为 table ，对应着在场景脚本中任务块参数
function p.start(args)
end

-- 返回任务脚本对象
return p
```
#### 内置任务脚本
##### Init
初始化场景
##### CreateSprite
创建精灵

| 必须 |  名称  |  类型  |     说明    |
| :---: | :-----: | :-----: | :--------: |
|   *   | name | string | 精灵名称 |
|   *   |  type  | string | 精灵类型 |

##### RemoveSprite
移除精灵

| 必须 |  名称  |  类型  |     说明    |
| :---: | :-----: | :-----: | :--------: |
|   *   | name | string | 精灵名称 |

##### SetSprite
设置精灵属性

| 必须 |  名称  |  类型  |     说明    |
| :---: | :-----: | :-----: | :--------: |
|   *   | name | string | 精灵名称 |
|       | arg1   | type1 | 需要设置的第一个参数的名称 |
|       | val1    | type1 | 需要设置的第一个参数的值 |
|| ... | ... | ... |

##### Goto
场景内跳转

| 必须 |  名称  |        类型        |     说明    |
| :---: | :-----: | :--------------: | :--------: |
|   *   |  pos   | string\number | 跳转目标 |

##### Wait
等待

| 必须 |  名称  |   类型   |     说明    |
| :---: | :-----: | :-------: | :--------: |
|   *   | name | number | 等待时间 |

### Lua精灵行为脚本
一个完整的Lua任务脚本如下：
```lua
local p = {}

-- 储存当前行为状态
p.enabled = true

-- 行为刷新
function p.update()
end

-- 行为启动
function p.start()
end

-- 返回行为脚本对象
return p
```
Lua精灵行为脚本与任务脚本很相似，区别是start方法不再需要参数。所有参数均被设置到为行为脚本创建的表中，之所以设计这一区别，是因为任务脚本的参数可变性要比行为脚本大的多，行为脚本的参数基本固定，而任务脚本的参数多变，如内置的 *SetSprite* 脚本中，根本无法预知有什么参数，这样把参数绑定到对应脚本的表中的意义就不大了。